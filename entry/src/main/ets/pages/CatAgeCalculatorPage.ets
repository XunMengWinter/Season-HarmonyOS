import router from '@ohos.router';
import DateUtil from '../net/DateUtil';

@Entry
@Component
struct CatAgeCalculatorPage {
  @State selectedDate: Date = new Date();
  @State dateStr: string = '';
  @State meowAgeStr: string = 'ç¬¬ xx å¤©';
  @State ageStr: string = 'xx å²';
  @State showDatePicker: boolean = false;
  private minimumDate: Date = new Date('2000-01-01');
  private maximumDate: Date = new Date();

  build() {
    Stack() {
      Column() {
        Text()
          .flexGrow(1)

        Image($r('app.media.ic_pink_cat'))
          .width(150)
          .height(150)
          .margin({
            left: 50
          })

        // Display the local image
        Image($r('app.media.ic_cat_house'))
          .width(200)
          .height(200)
          .margin({
            top: -8
          })
      }
      .height("100%")

      // Background gradient
      Column() {
        Text('â†')// Unicode å·¦ç®­å¤´ç¬¦å·
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .padding(16)
          .opacity(0)
        Text('çŒ«å’ªå¹´é¾„è®¡ç®—å™¨')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor("#ff4d91b5")
          .margin({ top: 20 });

        Button(("ðŸ£  "  + this.dateStr) || 'é€‰æ‹©æ—¥æœŸ')
          .onClick(() => {
            this.showDatePicker = true;
          })
          .backgroundColor("#cdf4e3")
          .fontColor("#505050")
          .fontWeight(FontWeight.Bold)
          .width('70%')
          .borderRadius(10)
          .margin(32)
          .padding(16);

        Column() {
          // Meow Age
          Row() {
            Text('å–µé¾„:')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.Gray)
              .flexGrow(1)
            Text(this.meowAgeStr)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor("#85adc2")
          }
          .width("80%")
          .padding(16);

          // Human Equivalent Age
          Row() {
            Text('ç›¸å½“äºŽäººç±»:')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor(Color.Gray)
              .flexGrow(1)
            Text(this.ageStr)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.Orange);
          }
          .width("80%")
          .padding(16);
        }
        .backgroundColor(Color.White)
        .borderRadius(10)
        .margin(24)
        .padding(16);
      }
      .width('100%');

      if (this.showDatePicker) {
        // Date Picker Modal
        Stack() {
          Column() {
            Text('é€‰æ‹©çŒ«å’ªå‡ºç”Ÿæ—¥æœŸ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 16 });

            DatePicker({
              selected: this.selectedDate,
              start: this.minimumDate,
              end: this.maximumDate
            })
              .onDateChange(date => {
                this.selectedDate = date;
              })
              .width('90%')
              .margin({ top: 16 });

            Button('ç¡®è®¤')
              .onClick(() => {
                this.handleDateChange(this.selectedDate);
                this.showDatePicker = false;
              })
              .margin({ top: 16 })
              .padding({ top: 12, bottom: 12 , left: 24, right: 24});
          }
          .padding({
            left: 16,
            right: 16,
            top: 16,
            bottom: 16
          })
          .backgroundColor(Color.White)
          .borderRadius(16);
        }
        .backgroundColor("#8000")
        .alignContent(Alignment.Center)
        .alignSelf(ItemAlign.Center)
        .width('100%')
        .height('100%');
      }

      Row() {
        Text('â†')// Unicode å·¦ç®­å¤´ç¬¦å·
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .padding(16)
          .onClick(() => {
            router.back() // è¿”å›žé€»è¾‘
          })
      }
      .width('100%')
    }
    .alignContent(Alignment.Top)
    .linearGradient({
      direction: GradientDirection.Bottom, // æ¸å˜æ–¹å‘
      repeating: false, // æ¸å˜é¢œè‰²æ˜¯å¦é‡å¤
      colors: [[0x500055ff, 0], [0xccffffff, 1]] // æ•°ç»„æœ«å°¾å…ƒç´ å æ¯”å°äºŽ1æ—¶æ»¡è¶³é‡å¤ç€è‰²æ•ˆæžœ
    })
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM])
    .onAppear(() => {
      if (this.dateStr == "") {
        this.selectedDate = DateUtil.getDateFromStamp("20240101")
        this.handleDateChange(this.selectedDate);
      }
    })
  }

  private handleDateChange(newDate: Date) {
    this.dateStr = this.formatDate(newDate);
    const diffDays = this.calculateDaysDifference(newDate);
    this.meowAgeStr = `ç¬¬ ${diffDays} å¤©`;
    this.ageStr = this.getMeowAge(diffDays);
  }

  private formatDate(date: Date): string {
    const options: Intl.DateTimeFormatOptions = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    };
    return date.toLocaleDateString('zh-CN', options);
  }

  private calculateDaysDifference(date: Date): number {
    const currentDate = new Date();
    const differenceInTime = currentDate.getTime() - date.getTime();
    return Math.ceil(differenceInTime / (1000 * 3600 * 24));
  }

  private getMeowAge(day: number): string {
    const month = day / 30.0;
    const year = day / 365.0;

    if (month < 1) {
      const num = Math.floor(month * 12);
      return `${num}ä¸ªæœˆ`;
    }

    if (month < 3) {
      const num = Math.floor(1 + (month - 1) * 2);
      return `${num}å²`;
    }

    if (month < 6) {
      const age = Math.floor(5 + (month - 3) * 1.33);
      return `${age}å²`;
    }

    if (month < 12) {
      const age = Math.floor(9 + (month - 6));
      return `${age}å²`;
    }

    if (month < 24) {
      const age = Math.floor(15 + (year - 1) * 9);
      return `${age}å²`;
    }

    const age = Math.floor(24 + (year - 2) * 4);
    return `${age}å²`;
  }
}