import { CalendarDay } from '../model/CalendarDay';
import { CalendarViewModel } from '../viewmodel/CalendarViewModel';
import { PostCardView } from './PostCardView';
import PrivacyPolicyDialogBackUp from './PrivacyPolicyDialogBackUp';
import { process } from '@kit.ArkTS';
import preferences from '@ohos.data.preferences';


// éšç§æ”¿ç­–çš„ URL
const privacyPolicyURL = "https://zzz.pet/?page_id=135";

// å¼¹çª—ç»„ä»¶
function showPrivacyPolicy() {
  AlertDialog.show({
    title: "ğŸ± åˆæ¬¡ç›¸è§ï¼Œä½ å¥½å–µ",
    message: "æˆ‘ä»¬æ˜¯ çŒ«ä¸çŒ«å¯»ï¼ˆæ­å·ï¼‰æ™ºèƒ½ç§‘æŠ€æœ‰é™å…¬å¸ï¼Œã€ŒçŒ«å’ªæ—¥å†ã€æ˜¯æˆ‘ä»¬å¼€å‘çš„Appã€‚è¯¥Appä¸ä¼šæ”¶é›†æ‚¨çš„ä¿¡æ¯ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨å–µï½\n\nhttps://zzz.pet/?page_id=135",
    autoCancel: false, //ç‚¹å‡»é®éšœå±‚æ—¶ï¼Œæ˜¯å¦å…³é—­å¼¹çª—ã€‚é»˜è®¤å€¼ï¼štrue
    alignment: DialogAlignment.Center, //å¼¹çª—åœ¨ç«–ç›´æ–¹å‘ä¸Šçš„å¯¹é½æ–¹å¼ã€‚é»˜è®¤å€¼ï¼šDialogAlignment.Default
    primaryButton: {
      value: "é€€å‡ºApp",
      fontColor: '#181818',
      action: () => {
      }
    },
    secondaryButton: {
      value: "åŒæ„",
      action: () => {
      }
    },
    cornerRadius: 12, //å¼¹çª—è¾¹æ¡†å¼§åº¦
    width: '80%', //å¼¹çª—å®½åº¦
  })
}


@Preview
@Entry
@Component
struct CalendarView {
  @State viewModel: CalendarViewModel = new CalendarViewModel();
  private scroller: ListScroller = new ListScroller()
  privacyPolicyDialog: CustomDialogController = new CustomDialogController({
    builder: PrivacyPolicyDialogBackUp({
      cancel: this.onCancel.bind(this),
      confirm: this.onAgree.bind(this)
    }),
    alignment: DialogAlignment.Default, // å¯è®¾ç½®dialogçš„å¯¹é½æ–¹å¼ï¼Œè®¾å®šæ˜¾ç¤ºåœ¨åº•éƒ¨æˆ–ä¸­é—´ç­‰ï¼Œé»˜è®¤ä¸ºåº•éƒ¨æ˜¾ç¤º
    cornerRadius: 16,
    autoCancel: false
  })

  build() {
    Column({ space: 16 }) {
      // Show loading state
      if (this.viewModel.isLoading) {
        Text('Loading...')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .textAlign(TextAlign.Center);
      } else {
        List({ space: 8, scroller: this.scroller }) {
          ForEach(this.viewModel.calendarDays, (item: CalendarDay, index: number) => {
            PostCardView({ post: item })
              .id(item.datestamp)
          })
        }
        // .expandSafeArea([SafeAreaType.SYSTEM])
        // .expandSafeArea([SafeAreaType.CUTOUT])
        .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
      }
    }
    .onAppear(() => {
      const context: Context = getContext(this) as Context;
      preferences.getPreferences(context, "season")
        .then(prefs => {
          // è¯»å–ä¿å­˜çš„æ•°æ®
          const hasAgree = prefs.getSync('hasAgree', false); // é»˜è®¤å€¼æ˜¯ false
          console.log("è·å–PreferencesæˆåŠŸ, ç”¨æˆ·æ˜¯å¦åŒæ„åè®® " + hasAgree);
          if (hasAgree == false) {
            this.privacyPolicyDialog.open()
          }
        })

      if (this.viewModel.calendarDays.length < 30) {
        this.viewModel.fetchCalendarDays()
          .then(() => {
            const today = this.getTodayDate();
            const firstDate = this.viewModel.calendarDays[0]?.datestamp || '';
            const lastDate = this.viewModel.calendarDays[this.viewModel.calendarDays.length - 1]?.datestamp || '';
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦åœ¨èŒƒå›´å†…
            if (today > firstDate && today < lastDate) {
              console.info(`Today's date ${today} is within range: ${firstDate} - ${lastDate}`);
              // æ‰¾åˆ°ä»Šå¤©æ—¥æœŸæ‰€åœ¨çš„ç´¢å¼•
              const targetIndex = this.viewModel.calendarDays.findIndex(day => day.datestamp === today);
              // å¦‚æœæ‰¾åˆ°å¯¹åº”ç´¢å¼•ï¼Œæ»šåŠ¨åˆ°ç›®æ ‡é¡¹
              if (targetIndex >= 0) {
                setTimeout(() => {
                  this.scroller.scrollToIndex(targetIndex, false)
                }, 100)
              } else {
                console.warn('Today is within range but not found in the list');
              }
            } else {
              console.warn(`Today's date ${today} is out of range: ${firstDate} - ${lastDate}`);
            }
          })
      }
    })
  }

  onCancel() {
    console.log("User cancelled the privacy policy dialog.");
    process.exit(0)
  }

  onAgree() {
    console.log("User agreed to the privacy policy.");
    console.log("ç”¨æˆ·ç‚¹å‡»äº†åŒæ„ï¼Œä¿å­˜è®°å½•");
    const context: Context = getContext(this) as Context;
    preferences.getPreferences(context, "season")
      .then(prefs => {
        console.log("è·å–PreferencesæˆåŠŸ");
        // å­˜å‚¨æ•°æ®åˆ°Preferences
        // ä½¿ç”¨putæ–¹æ³•ä¿å­˜key-valueå¯¹
        prefs.put('hasAgree', true);
        prefs.flush()
      })

  }

  // è·å–ä»Šå¤©çš„æ—¥æœŸï¼Œæ ¼å¼ä¸º YYYYMMDD
  private getTodayDate(): string {
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0'); // æœˆä»½è¡¥é›¶
    const day = today.getDate().toString().padStart(2, '0'); // æ—¥æœŸè¡¥é›¶
    console.log("ç°åœ¨çš„æ—¶é—´" + today.getHours() + ":" + today.getMinutes())
    return `${year}${month}${day}`; // è¿”å› YYYYMMDD æ ¼å¼
  }
}